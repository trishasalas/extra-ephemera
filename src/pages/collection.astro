---
import Layout from '../layouts/Layout.astro';
---

<Layout>
    <div class="container">
        <header>
            <h1>üå± My Collection</h1>
            <p>The Mosslight Nook Plant Catalog</p>
            <nav class="header-nav">
                <a href="/">Search Trefle</a>
                <a href="/add">Add Cultivar</a>
            </nav>
        </header>

        <div id="loading" class="loading">Loading your plants...</div>
        <div id="collection" class="collection"></div>
    </div>

    <template id="plant-card-template">
        <div class="plant-card">
            <img class="card-image" alt="" width="200px">
            <div class="no-image">No image</div>
            <div class="card-content">
                <h3><a href="#" class="card-link"></a></h3>
                <p class="subtitle"></p>
                <p class="taxonomy"></p>
                <p class="location"></p>
                <div class="care-info">
                    <span class="care-item watering">üíß <span class="watering-text"></span></span>
                    <span class="care-item sunlight">‚òÄÔ∏è <span class="sunlight-text"></span></span>
                </div>
                <span class="status-badge"></span>
            </div>
        </div>
    </template>
</Layout>

<script>
interface Plant {
    id: number;
    scientific_name: string;
    common_name?: string | null;
    family?: string | null;
    nickname?: string | null;
    location?: string | null;
    status?: string | null;
    image_url?: string | null;
    metadata?: {
        source?: string;
        care?: {
            water?: string;
            light?: string;
            pruning?: string;
        };
    };
}

async function loadCollection() {
    const loadingEl = document.getElementById('loading');
    const collectionEl = document.getElementById('collection');

    if (!loadingEl || !collectionEl) return;

    try {
        const response = await fetch('/api/plants/list');
        const data = await response.json();

        loadingEl.style.display = 'none';

        if (data.plants && data.plants.length > 0) {
            displayCollection(data.plants);
        } else {
            collectionEl.innerHTML = `
                <div class="empty-state">
                    <p>No plants yet!</p>
                    <p><a href="/">Search Trefle</a> or <a href="/add">add a cultivar</a> to get started.</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading collection:', error);
        loadingEl.textContent = 'Error loading plants. Please refresh.';
    }
}

function displayCollection(plants: Plant[]) {
    const collectionEl = document.getElementById('collection');
    if (!collectionEl) return;

    collectionEl.innerHTML = '';

    plants.forEach(plant => {
        const card = createPlantCard(plant);
        collectionEl.appendChild(card);
    });
}

function createPlantCard(plant: Plant): HTMLElement {
    const template = document.getElementById('plant-card-template') as HTMLTemplateElement;
    if (!template) throw new Error('Template not found');

    const card = template.content.cloneNode(true) as DocumentFragment;
    const cardEl = card.querySelector('.plant-card') as HTMLElement;

    // Handle image
    const img = card.querySelector('.card-image') as HTMLImageElement;
    const noImage = card.querySelector('.no-image') as HTMLElement;
    if (plant.image_url) {
        img.src = plant.image_url;
        img.alt = plant.scientific_name;
        noImage.remove();
    } else {
        img.remove();
    }

    // Set link and display name
    const link = card.querySelector('.card-link') as HTMLAnchorElement;
    const displayName = plant.nickname || plant.common_name || plant.scientific_name;
    link.href = `/plant?id=${plant.id}`;
    link.textContent = displayName;

    // Handle subtitle
    const subtitleEl = card.querySelector('.subtitle') as HTMLElement;
    const subtitle = plant.common_name ? (plant.nickname || plant.scientific_name) : plant.scientific_name;
    if (displayName !== subtitle) {
        subtitleEl.textContent = `Scientific Name: ${subtitle}`;
    } else {
        subtitleEl.remove();
    }

    // Handle family
    const taxonomyEl = card.querySelector('.taxonomy') as HTMLElement;
    if (plant.family) {
        taxonomyEl.textContent = `Family: ${plant.family}`;
    } else {
        taxonomyEl.remove();
    }

    // Handle location
    const locationEl = card.querySelector('.location') as HTMLElement;
    if (plant.location) {
        locationEl.textContent = `üìç ${plant.location}`;
    } else {
        locationEl.remove();
    }

    // Handle care info
    const careInfoEl = card.querySelector('.care-info') as HTMLElement;
    const care = plant.metadata?.care;

    if (care && (care.water || care.light)) {
        // Watering
        const wateringItem = card.querySelector('.watering') as HTMLElement;
        const wateringText = card.querySelector('.watering-text') as HTMLElement;
        if (care.water) {
            // Shorten long watering descriptions
            wateringText.textContent = care.water.length > 30
                ? care.water.substring(0, 30) + '...'
                : care.water;
        } else {
            wateringItem.remove();
        }

        // Light/Sunlight
        const sunlightItem = card.querySelector('.sunlight') as HTMLElement;
        const sunlightText = card.querySelector('.sunlight-text') as HTMLElement;
        if (care.light) {
            sunlightText.textContent = care.light;
        } else {
            sunlightItem.remove();
        }
    } else {
        careInfoEl.remove();
    }

    // Handle status
    const statusEl = card.querySelector('.status-badge') as HTMLElement;
    if (plant.status) {
        statusEl.textContent = plant.status;
    } else {
        statusEl.remove();
    }

    return cardEl;
}

document.addEventListener('DOMContentLoaded', loadCollection);
</script>
